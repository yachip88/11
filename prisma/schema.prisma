generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RTS {
  id        String   @id @default(uuid())
  name      String   @db.Text
  code      String   @unique
  location  String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")

  districts Districts[]
  ctps      CTP[]

  @@map("rts")
}

model Districts {
  id        String   @id @default(uuid())
  name      String   @db.Text
  rtsId     String?  @map("rts_id")
  createdAt DateTime @default(now()) @map("created_at")

  rts  RTS?  @relation(fields: [rtsId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ctps CTP[]

  @@map("districts")
}

model CTP {
  id           String   @id @default(uuid())
  name         String   @db.Text
  code         String   @unique
  rtsId        String?  @map("rts_id")
  districtId   String?  @map("district_id")
  ucl          Float?
  cl           Float?
  lcl          Float?
  hasMeter     Boolean  @default(true) @map("has_meter")
  meterStatus  String   @default("working") @map("meter_status")
  createdAt    DateTime @default(now()) @map("created_at")

  rts                 RTS?                  @relation(fields: [rtsId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  district            Districts?            @relation(fields: [districtId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  measurements        Measurements[]
  statisticalParams   StatisticalParams[]
  recommendations     Recommendations[]

  @@map("ctp")
}

model Measurements {
  id          String   @id @default(uuid())
  ctpId       String   @map("ctp_id")
  date        DateTime
  makeupWater Float    @map("makeup_water")
  undermix    Float    @default(0)
  flowG1      Float?   @map("flow_g1")
  temperature Float?
  pressure    Float?
  createdAt   DateTime @default(now()) @map("created_at")

  ctp CTP @relation(fields: [ctpId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("measurements")
}

model StatisticalParams {
  id           String   @id @default(uuid())
  ctpId        String   @map("ctp_id")
  mean         Float
  stdDev       Float    @map("std_dev")
  ucl          Float
  cl           Float
  lcl          Float
  sampleSize   Int      @map("sample_size")
  calculatedAt DateTime @default(now()) @map("calculated_at")

  ctp CTP @relation(fields: [ctpId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("statistical_params")
}

model Recommendations {
  id          String   @id @default(uuid())
  ctpId       String   @map("ctp_id")
  type        String
  priority    String
  title       String   @db.Text
  description String   @db.Text
  actions     String?  @db.Text
  status      String   @default("open")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  ctp CTP @relation(fields: [ctpId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("recommendations")
}

model UploadedFiles {
  id               String   @id @default(uuid())
  filename         String   @db.Text
  originalName     String   @map("original_name") @db.Text
  fileType         String   @map("file_type")
  size             Int
  status           String   @default("processing")
  recordsProcessed Int      @default(0) @map("records_processed")
  errors           String?  @db.Text
  uploadedAt       DateTime @default(now()) @map("uploaded_at")

  @@map("uploaded_files")
}
